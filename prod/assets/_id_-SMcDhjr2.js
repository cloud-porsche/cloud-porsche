import{d as G,o as p,c as E,z as k,A as de,B as be,h as q,j as oe,r as f,C as Ce,w as a,l as t,D as ne,E as ge,F as S,t as O,u as i,G as De,I as we,J as ke,K as J,L as Se,M as K,b as w,x as P,N as he,q as Ve,s as R,O as se,P as xe,k as U,p as W,T as A,f as $,Q as ce,R as _e,S as ye,U as Ue,W as Z,V as Ie,X as ee,Y as te,Z as ae,_ as Ne,$ as Re,a0 as pe,a1 as fe,a2 as me,a3 as $e,a4 as le,a5 as Ee}from"./index-CY7nOk5p.js";import{V as M,a as Fe}from"./VChip-PKdmnwD0.js";import{V as Le,a as L}from"./VRow-Dl5gG6n6.js";import{V as Te}from"./VTextarea-C6n0hv8s.js";import{V as Oe}from"./VSelect-DnwuabJ-.js";import{V as We}from"./VFileInput-DFaZ0aEn.js";import{V as Ae}from"./VDataTable-DUDUTxIE.js";import{u as ve}from"./index-E_Ben5xt.js";import"./VPagination-CrSuduao.js";const ie=G({__name:"StatusChip",props:{defect:{}},setup(T){function F(l){switch(l){case k.DefectState.OPEN:return"Open";case k.DefectState.IN_WORK:return"In Work";case k.DefectState.REJECTED:return"Rejected";case k.DefectState.DONE:return"Done";default:return"Unknown"}}function r(l){switch(l){case k.DefectState.OPEN:return"green";case k.DefectState.IN_WORK:return"blue";case k.DefectState.REJECTED:return"red";case k.DefectState.DONE:return"grey";default:return"black"}}return(l,_)=>(p(),E(M,{color:r(l.defect.status),text:F(l.defect.status),class:"text-uppercase",size:"small",label:""},null,8,["color","text"]))}}),Ye=G({__name:"AddDefectPopup",props:de({defect:{},patch:{type:Boolean}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:de(["save","patch","close"],["update:modelValue"]),setup(T,{emit:F}){const r=be(T,"modelValue"),l=T,_=q(()=>l.defect),m=q(()=>l.patch??!1);oe(_,()=>{C.value=l.defect.name??"",I.value=l.defect.location??"",g.value=l.defect.descriptionShort??"",V.value=l.defect.descriptionLong??"",b.value=l.defect.reportedDate?new Date(l.defect.reportedDate):new Date,u.value=l.defect.status,D.value=l.defect.image?new File([],l.defect.image,{type:"image/png"}):void 0});const C=f(l.defect.name??""),I=f(l.defect.location??""),g=f(l.defect.descriptionShort??""),V=f(l.defect.descriptionLong??""),b=f(l.defect.reportedDate?new Date(l.defect.reportedDate):new Date),D=f(l.defect.image?new File([],l.defect.image,{type:"image/png"}):void 0),u=f(l.defect.status),d=f(!1),h=c=>!!c||"This field is required.",Y=F;function j(){d.value&&B()}const H=[c=>!c||!c.length||c[0].size<2e6||"File size should be less than 2MB",c=>!c||!c.length||c[0].type.startsWith("image/")||"File must be an image"];function B(){var o;const c={name:C.value,location:I.value,descriptionShort:g.value,descriptionLong:V.value,reportedDate:Q(b.value),image:D.value?D.value.name===l.defect.image?l.defect.image:crypto.randomUUID()+"."+((o=D.value)==null?void 0:o.name.split(".").pop()):""};m.value?Y("patch",[{...c,status:u.value},D.value,l.defect.image]):Y("save",c,D.value),z()}function z(){r.value=!1}function Q(c){const o=c.getTimezoneOffset();return new Date(c.getTime()-o*60*1e3)}return(c,o)=>{const X=Ce("v-date-input"),n=ie;return p(),E(se,{modelValue:r.value,"onUpdate:modelValue":o[8]||(o[8]=e=>r.value=e),"max-width":"600"},{default:a(()=>[t(ne,null,{default:a(()=>[t(ge,null,{default:a(()=>[S(O(i(m)?"Change":"Add New")+" Defect ",1)]),_:1}),t(De,null,{default:a(()=>[t(we,{modelValue:d.value,"onUpdate:modelValue":o[7]||(o[7]=e=>d.value=e),onSubmit:ke(j,["prevent"])},{default:a(()=>[t(Le,{dense:""},{default:a(()=>[t(L,{cols:"12",md:"6"},{default:a(()=>[t(J,{label:"Defect Name*",modelValue:C.value,"onUpdate:modelValue":o[0]||(o[0]=e=>C.value=e),rules:[h]},null,8,["modelValue","rules"])]),_:1}),t(L,{cols:"12",md:"6"},{default:a(()=>[t(J,{label:"Location*",modelValue:I.value,"onUpdate:modelValue":o[1]||(o[1]=e=>I.value=e),rules:[h]},null,8,["modelValue","rules"])]),_:1}),t(L,{cols:"12"},{default:a(()=>[t(J,{label:"Short Description*",modelValue:g.value,"onUpdate:modelValue":o[2]||(o[2]=e=>g.value=e),rules:[h]},null,8,["modelValue","rules"])]),_:1}),t(L,{cols:"12"},{default:a(()=>[t(Te,{label:"Long Description*",modelValue:V.value,"onUpdate:modelValue":o[3]||(o[3]=e=>V.value=e),rules:[h]},null,8,["modelValue","rules"])]),_:1}),t(L,{cols:i(m)?6:12},{default:a(()=>[t(X,{label:"Select a date*",modelValue:b.value,"onUpdate:modelValue":o[4]||(o[4]=e=>b.value=e),rules:[h]},null,8,["modelValue","rules"])]),_:1},8,["cols"]),i(m)?(p(),E(L,{key:0,cols:"6"},{default:a(()=>[t(Oe,{label:"Status",items:[i(k.DefectState).OPEN,i(k.DefectState).IN_WORK,i(k.DefectState).DONE,i(k.DefectState).REJECTED],modelValue:u.value,"onUpdate:modelValue":o[5]||(o[5]=e=>u.value=e)},{selection:a(({item:e})=>[t(n,{defect:{status:e.raw}},null,8,["defect"])]),item:a(({props:e,item:x})=>[t(Se,{props:e,onClick:e.onClick},{default:a(()=>[t(n,{defect:{status:x.raw}},null,8,["defect"])]),_:2},1032,["props","onClick"])]),_:1},8,["items","modelValue"])]),_:1})):K("",!0),t(L,{cols:"12"},{default:a(()=>[t(We,{label:"Upload Image",rules:H,"validate-on":"eager",modelValue:D.value,"onUpdate:modelValue":o[6]||(o[6]=e=>D.value=e),accept:"image/*","prepend-icon":"mdi-image"},null,8,["modelValue"])]),_:1})]),_:1}),o[9]||(o[9]=w("small",{class:"text-caption"},"*indicates required field",-1))]),_:1},8,["modelValue"])]),_:1}),t(P),t(he,null,{default:a(()=>[t(Ve),t(R,{text:"Cancel",onClick:z},{default:a(()=>o[10]||(o[10]=[S("Cancel")])),_:1}),t(R,{disabled:!d.value,color:"primary",onClick:j},{default:a(()=>o[11]||(o[11]=[S(" Save ")])),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}}),Me={class:"d-flex w-100 pb-1"},Pe=G({__name:"SearchFilter",props:{loading:{type:Boolean},error:{type:Boolean}},emits:["updateList","refresh","add"],setup(T,{emit:F}){const{mobile:r}=xe(),l=f(""),_=f("name"),m=F,C=T,I=q(()=>C.error);function g(){b()}function V(){b()}function b(){m("updateList",l.value,_.value)}return(D,u)=>(p(),U(ye,null,[w("h1",Me,[u[5]||(u[5]=S(" Defects ")),t(Ve),W(t(R,{"prepend-icon":i(r)?void 0:"mdi-plus",icon:i(r)?"mdi-plus":void 0,onClick:u[0]||(u[0]=d=>m("add")),class:"me-2",text:i(r)?"":"Add Defect",disabled:i($)().isUserRole},null,8,["prepend-icon","icon","text","disabled"]),[[A,i($)().isUserRole?"Not enough permissions!":"Add Defect"]]),W(t(R,{"prepend-icon":i(r)?void 0:"mdi-refresh",icon:i(r)?"mdi-refresh":void 0,onClick:u[1]||(u[1]=d=>m("refresh")),loading:D.loading,color:i(I)?"error":"primary",text:i(r)?"":"Refresh"},null,8,["prepend-icon","icon","loading","color","text"]),[[A,"Refresh"]])]),t(P,{class:"pa-1",thickness:"0"}),t(J,{loading:D.loading,modelValue:i(l),"onUpdate:modelValue":u[2]||(u[2]=d=>ce(l)?l.value=d:null),density:"comfortable",label:"Search","prepend-inner-icon":"mdi-magnify",variant:"solo-filled",flat:"","hide-details":"","single-line":"",onInput:g,onKeydown:_e(g,["enter"]),clearable:"","onClick:clear":u[3]||(u[3]=d=>{l.value="",g()}),error:i(I)},null,8,["loading","modelValue","error"]),t(P,{class:"pa-1",thickness:"0"}),t(Fe,{filter:"",modelValue:i(_),"onUpdate:modelValue":u[4]||(u[4]=d=>ce(_)?_.value=d:null),"selected-class":"text-primary",mandatory:"",onChange:V},{default:a(()=>[t(M,{text:"ID",value:"id",variant:"outlined"}),t(M,{text:"Name",value:"name",variant:"outlined"}),t(M,{text:"Location",value:"location",variant:"outlined"}),W(t(M,{text:"Date",value:"reportedDate",variant:"outlined"},null,512),[[A,"e.g. YYYY-MM-DD"]])]),_:1},8,["modelValue"]),t(P,{class:"pa-1",thickness:"0"})],64))}}),je={class:"d-flex align-center justify-center fill-height"},Be={class:"d-flex align-center justify-center fill-height"},ze=["colspan"],Je={key:0},Ke={key:1},qe={key:2},Ge={class:"d-flex align-center justify-start fill-height"},He={class:"d-flex align-center justify-start fill-height"},Qe={key:1},Xe={key:3},Ze={key:4},et={class:"d-flex flex-column align-center justify-center fill-height"},tt={class:"d-flex align-center justify-center fill-height"},ct=G({__name:"[id]",setup(T){const{mobile:F}=xe(),r=f(!0),l=f(!1),_=f([]),m=f(!1),C=f(!1),I=Ue(),g=q(()=>I.params.id),V=f({open:!1,src:void 0});oe(m,n=>{n||H()});const b=f({}),D=f(void 0),u=[{title:"ID",value:"id",sortable:!0,maxWidth:"100px"},{title:"Name",value:"name",sortable:!0,maxWidth:"100px",nowrap:!0},{title:"Location",value:"location",sortable:!0,maxWidth:"100px",nowrap:!0},{title:"Description Short",value:"descriptionShort",sortable:!0,maxWidth:"120px",nowrap:!0},{title:"Description Long",value:"descriptionLong",sortable:!0,maxWidth:"100px",nowrap:!0},{title:"Reported Date",value:"reportedDate",nowrap:!0},{title:"Status",value:"status",sortable:!0,maxWidth:"100px"},{title:"Image",value:"signedImage",sortable:!1,nowrap:!0,maxWidth:"150px"},{title:"Actions",value:"actions",sortable:!1,nowrap:!0,maxWidth:"100px"}];h(),oe(g,()=>{h()});function d(n){r.value=!1,l.value=!0}function h(){if(!g.value){console.error("Property ID is missing");return}r.value=!0,Z(`/v1/defects?propertyId=${g.value}`).json().then(async n=>{_.value=await Promise.all(n.map(async e=>(e.signedImage=await Y(e.image),e))),r.value=!1,l.value=!1}).catch(d)}async function Y(n){if(!n)return"";try{const e=await Z(`/v1/storage/${n}`);if(!e.ok)throw new Error("Failed to fetch signed URL");const{signedUrl:x}=await e.json();return x}catch(e){return console.error("Error fetching signed URL:",e),""}}function j(){m.value=!0}function H(){m.value=!1,setTimeout(()=>b.value={},100)}function B(n){b.value=n,m.value=!0}function z(n){if(!n){console.error("No defect to delete");return}D.value=n,C.value=!0}function Q(n,e){if(n.propertyId=g.value,r.value=!0,e){const x=new File([e],n.image,{type:e.type}),y=new FormData;y.append("file",x),pe("/v1/storage/upload",y).then(()=>fe("/v1/defects",n).then(()=>{h()})).catch(d)}else fe("/v1/defects",n).then(()=>{h()}).catch(d);m.value=!1}function c(n,e){if(!g.value){console.error("Property ID is missing");return}r.value=!0,Z(`/v1/defects/search?search=${n}&filter=${e}&propertyId=${g.value}`).json().then(async x=>{_.value=await Promise.all(x.map(async y=>(y.signedImage=await Y(y.image),y))),r.value=!1,l.value=!1}).catch(d)}function o(n){r.value=!0,me(`/v1/defects/${n}`).then(()=>{h()}),C.value=!1}function X(n,e,x,y){if(r.value=!0,x&&e.image&&y!==e.image){const s=new File([x],e.image,{type:x.type}),v=new FormData;v.append("file",s),(y?$e(`/v1/storage/upload/${y}`,v):pe("/v1/storage/upload",v)).then(()=>le(`/v1/defects/${n}`,e).then(()=>{h()})).catch(d)}else!x&&y?me(`/v1/storage/${y}`).then(()=>{le(`/v1/defects/${n}`,e).then(()=>{h()})}).catch(d):le(`/v1/defects/${n}`,e).then(()=>{h()}).catch(d)}return(n,e)=>{const x=Pe,y=Ye;return p(),U("div",null,[t(Ie,null,{default:a(()=>[t(x,{onUpdateList:c,onRefresh:e[0]||(e[0]=s=>h()),onAdd:j,error:l.value,loading:r.value},null,8,["error","loading"]),t(Ae,{class:"data-table rounded",mobile:i(F),density:"comfortable","no-data-text":l.value?"A network error occurred âš¡":"No defects found",items:_.value,headers:u,"items-per-page-options":[{value:5,title:"5"},{value:10,title:"10"},{value:25,title:"25"},{value:-1,title:"All"}],"show-expand":"","multi-sort":""},{"item.status":a(({item:s})=>[t(ie,{defect:s},null,8,["defect"])]),"item.reportedDate":a(({item:s})=>[S(O(i(ve)(s.reportedDate,"MM.DD.YYYY")),1)]),"item.signedImage":a(({item:s})=>{var v;return[((v=s.signedImage)==null?void 0:v.length)>0?(p(),E(ae,{key:0,src:s.signedImage,class:"cursor-pointer","aspect-ratio":"1",contain:"",onClick:N=>V.value={open:!0,src:s.signedImage}},{error:a(()=>[w("div",je,[t(ee,{color:"error",icon:"mdi-image-broken-variant"})])]),placeholder:a(()=>[w("div",Be,[t(te,{size:"24",indeterminate:""})])]),_:2},1032,["src","onClick"])):K("",!0)]}),"item.actions":a(({item:s})=>[W(t(R,{icon:"mdi-pencil",onClick:v=>B(s),variant:"plain",disabled:i($)().isUserRole},null,8,["onClick","disabled"]),[[A,i($)().isUserRole?"Not enough permissions!":"Edit"]])]),"expanded-row":a(({columns:s,item:v})=>[w("tr",null,[w("td",{colspan:s.length,class:"pa-5"},[(p(!0),U(ye,null,Ne(s,N=>{var re;return p(),U("div",{key:N.value,class:"expanded-defect pa-2"},[w("strong",null,O(N.title),1),N.value==="reportedDate"?(p(),U("div",Je,O(i(ve)(v.reportedDate,"MM.DD.YYYY HH:mm")),1)):N.value==="status"?(p(),U("div",Ke,[t(ie,{defect:v},null,8,["defect"])])):N.value==="signedImage"?(p(),U("div",qe,[((re=v.signedImage)==null?void 0:re.length)>0?(p(),E(ae,{key:0,src:v.signedImage,class:"cursor-pointer",contain:"",position:"left","max-height":"300",onClick:ue=>V.value={open:!0,src:v.signedImage}},{error:a(()=>[w("div",Ge,[W(t(ee,{color:"error",size:"50",icon:"mdi-image-broken-variant"},null,512),[[A,"Corrupted or missing Image"]])])]),placeholder:a(()=>[w("div",He,[t(te,{indeterminate:""})])]),_:2},1032,["src","onClick"])):(p(),U("i",Qe,"No image."))])):N.value==="actions"?(p(),U("div",Xe,[W((p(),E(R,{"prepend-icon":"mdi-pencil",class:"me-2",onClick:ue=>B(v),variant:"tonal",disabled:i($)().isUserRole},{default:a(()=>e[8]||(e[8]=[S("Edit ")])),_:2},1032,["onClick","disabled"])),[[A,i($)().isUserRole?"Not enough permissions!":"Edit"]]),t(R,{"prepend-icon":"mdi-delete",color:"error",onClick:ue=>z(v),variant:"flat",disabled:i($)().isUserRole},{default:a(()=>[e[9]||(e[9]=S("Delete ")),t(Ee,{disabled:!i($)().isUserRole,activator:"parent",text:"Not enough permissions!"},null,8,["disabled"])]),_:2},1032,["onClick","disabled"])])):(p(),U("div",Ze,O(v[N.value]),1)),N.title!==""?(p(),E(P,{key:5,class:"mt-2"})):K("",!0)])}),128))],8,ze)])]),_:1},8,["mobile","no-data-text","items"]),t(se,{modelValue:V.value.open,"onUpdate:modelValue":e[2]||(e[2]=s=>V.value.open=s),"max-width":"50%","max-height":"80%"},{default:a(()=>[t(ne,{rounded:"",class:"d-flex flex-row overflow-hidden"},{default:a(()=>[V.value.src?(p(),E(ae,{key:0,src:V.value.src,contain:"","max-height":"100%","min-height":"300",rounded:"",onClick:e[1]||(e[1]=s=>V.value={open:!1,src:void 0})},{error:a(()=>[w("div",et,[t(ee,{color:"error",size:"100",icon:"mdi-image-broken-variant"}),e[10]||(e[10]=w("i",{class:"pa-2 text-red-lighten-3"},"Corrupted or missing Image.",-1))])]),placeholder:a(()=>[w("div",tt,[t(te,{indeterminate:""})])]),_:1},8,["src"])):K("",!0)]),_:1})]),_:1},8,["modelValue"]),t(y,{modelValue:m.value,"onUpdate:modelValue":e[3]||(e[3]=s=>m.value=s),defect:b.value,patch:!!b.value.id,onSave:Q,onPatch:e[4]||(e[4]=s=>X(b.value.id,s[0],s[1],s[2]))},null,8,["modelValue","defect","patch"])]),_:1}),t(se,{modelValue:C.value,"onUpdate:modelValue":e[7]||(e[7]=s=>C.value=s),"max-width":"400"},{default:a(()=>[t(ne,null,{default:a(()=>[t(ge,null,{default:a(()=>e[11]||(e[11]=[S("Confirm Delete")])),_:1}),t(Re,null,{default:a(()=>[S("Defect name: "+O(D.value.name),1)]),_:1}),t(De,null,{default:a(()=>e[12]||(e[12]=[S("Are you sure you want to delete this defect?")])),_:1}),t(he,null,{default:a(()=>[t(R,{variant:"text",onClick:e[5]||(e[5]=s=>C.value=!1)},{default:a(()=>e[13]||(e[13]=[S("Cancel")])),_:1}),t(R,{color:"error",variant:"flat",onClick:e[6]||(e[6]=s=>o(D.value.id)),autofocus:""},{default:a(()=>e[14]||(e[14]=[S(" Delete ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}});export{ct as default};
